<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ghana Storefront</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#198754">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .product-card {
      border: 1px solid #ddd; border-radius: 6px; background: #fff; padding: 10px;
      margin-bottom: 20px; height: 100%;
    }
    .product-card img {
      width: 100%; height: 180px; object-fit: cover; border-radius: 5px;
    }
    .hero-banner {
      width: 100%; max-height: 280px; object-fit: cover; border-radius: 10px;
    }
    .badge-ship { font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container py-4">
  <img src="assets/banner.jpg" alt="Shop Banner" class="hero-banner mb-3">

  <div class="text-center mb-4">
    <h2>üõçÔ∏è Welcome to Majorine Ventures</h2>
    <p>Get great deals shipped from China to Ghana.<br>üöö Sea & ‚úàÔ∏è Air freight available. All prices in GHS.</p>
    <p class="small text-muted">If shipping isn't included, it won‚Äôt exceed 100% of the sales price.</p>
    <a class="btn btn-success" href="https://wa.me/YOURGROUPNUMBER" target="_blank">Join WhatsApp Group</a>
  </div>

  <div class="row mb-3">
    <div class="col-md-6 mb-2">
      <input id="searchBox" class="form-control" placeholder="Search product or category...">
    </div>
    <div class="col-md-6 mb-2">
      <select id="categoryFilter" class="form-select">
        <option value="">All Categories</option>
      </select>
    </div>
  </div>

  <div id="productList" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
</div>

<!-- Order Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="orderForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üì¶ Place Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="selectedProductName" />
        <div class="mb-2"><input required class="form-control" placeholder="Your Name" id="buyerName"></div>
        <div class="mb-2"><input required class="form-control" placeholder="Phone Number" id="buyerPhone"></div>
        <div class="mb-2"><input required class="form-control" placeholder="Location" id="buyerLocation"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Submit Order</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const productList = document.getElementById('productList');
  const searchBox = document.getElementById('searchBox');
  const categoryFilter = document.getElementById('categoryFilter');
  let products = [];

  function renderProducts(list) {
    productList.innerHTML = '';
    list.slice(0, 12).forEach(p => {
      if (!p.available) return;
      const card = document.createElement('div');
      card.className = 'col';
      card.innerHTML = `
        <div class="product-card h-100 d-flex flex-column justify-content-between">
          <div>
            <img src="assets/images/${p.category.toLowerCase()}/${p.image}" alt="${p.name}" />
            <h5 class="mt-2">${p.name}</h5>
            <p class="mb-1"><strong>Category:</strong> ${p.category}</p>
            <p class="mb-1"><strong>Price:</strong> GHS ${p.finalPrice}</p>
            <span class="badge bg-info text-dark badge-ship">${p.shippingNote}</span>
          </div>
          <button class="btn btn-sm btn-success mt-2" onclick="openOrder('${p.name}')">Order Now</button>
        </div>
      `;
      productList.appendChild(card);
    });
  }

  function updateFilters() {
    const search = searchBox.value.toLowerCase();
    const category = categoryFilter.value.toLowerCase();

    const filtered = products.filter(p => {
      const matchesSearch = p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search);
      const matchesCategory = !category || p.category.toLowerCase() === category;
      return matchesSearch && matchesCategory;
    });

    renderProducts(filtered);
  }

  function openOrder(productName) {
    document.getElementById('selectedProductName').value = productName;
    new bootstrap.Modal(document.getElementById('orderModal')).show();
  }

  document.getElementById('orderForm').onsubmit = function (e) {
    e.preventDefault();
    const product = document.getElementById('selectedProductName').value;
    const name = document.getElementById('buyerName').value;
    const phone = document.getElementById('buyerPhone').value;
    const location = document.getElementById('buyerLocation').value;
    const date = new Date().toLocaleString();
    const status = 'Pending';

    // Save to localStorage
    const order = { product, name, phone, location, date, status };
    const existing = JSON.parse(localStorage.getItem('sales') || '[]');
    existing.push(order);
    localStorage.setItem('sales', JSON.stringify(existing));

    // Format WhatsApp message
    const message = `üõí *Order from Majorine Storefront*:%0A` +
      `üßæ Product: ${product}%0A` +
      `üë§ Name: ${name}%0A` +
      `üìû Phone: ${phone}%0A` +
      `üìç Location: ${location}%0A` +
      `üìÖ Date: ${date}`;

    // Replace with your WhatsApp number (e.g. 233... no + or leading 0)
    const whatsappNumber = '+233269609634';
    const url = `https://wa.me/message/ELHL6MNXBJ2ZN1?text=${message}`;
    window.open(url, '_blank');

    // Reset form and close modal
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
  };

  searchBox.addEventListener('input', updateFilters);
  categoryFilter.addEventListener('change', updateFilters);

  async function loadProducts() {
    const local = localStorage.getItem('products');
    if (local) {
      products = JSON.parse(local);
    } else {
      try {
        const res = await fetch('data/products.json');
        products = await res.json();
        localStorage.setItem('products', JSON.stringify(products));
      } catch {
        productList.innerHTML = '<p class="text-danger">‚ùå Failed to load products.</p>';
        return;
      }
    }

    const categories = [...new Set(products.map(p => p.category))];
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categoryFilter.appendChild(opt);
    });

    renderProducts(products);
  }

  window.onload = loadProducts;
</script>

<!-- PWA: Install prompt -->
<script>
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.createElement('button');
    btn.className = 'btn btn-warning fixed-bottom w-100';
    btn.textContent = 'üì≤ Install this App';
    btn.onclick = () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => btn.remove());
    };
    document.body.appendChild(btn);
  });
</script>

<!-- PWA: Update available prompt -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        newWorker.onstatechange = () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info fixed-bottom text-center mb-0';
            alertDiv.innerHTML = 'üîÑ New version available. <button class="btn btn-sm btn-primary">Refresh</button>';
            alertDiv.querySelector('button').onclick = () => {
              newWorker.postMessage('SKIP_WAITING');
              window.location.reload();
            };
            document.body.appendChild(alertDiv);
          }
        };
      };
    });
  }
</script>

<!-- iOS install guide -->
<script>
  const isIOS = /iphone|ipad/i.test(navigator.userAgent);
  const isInStandalone = window.navigator.standalone === true;
  if (isIOS && !isInStandalone) {
    const iosTip = document.createElement('div');
    iosTip.className = 'alert alert-warning fixed-bottom text-center mb-0';
    iosTip.innerHTML = 'üì± To install, tap <strong>Share</strong> ‚Üí "Add to Home Screen"';
    document.body.appendChild(iosTip);
  }
</script>

</body>
</html>
